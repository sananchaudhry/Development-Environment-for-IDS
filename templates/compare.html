{% extends "base.html" %}
{% block content %}
<h2>Compare &amp; Rerun</h2>

{% if errors %}
  <div class="alert alert-danger">
    <ul class="mb-0">{% for err in errors %}<li>{{ err }}</li>{% endfor %}</ul>
  </div>
{% endif %}
{% if warnings %}
  <div class="alert alert-warning">
    <ul class="mb-0">{% for warn in warnings %}<li>{{ warn }}</li>{% endfor %}</ul>
  </div>
{% endif %}

<form action="/compare" method="POST" class="mb-4 p-3 border rounded bg-light">
  <div class="row g-3 align-items-end">
    <div class="col-md-4">
      <label class="form-label">Baseline run</label>
      <select name="baseline_id" class="form-select">
        <option value="" disabled {% if not baseline %}selected{% endif %}>Select a completed run</option>
        {% for run in runs %}
          <option value="{{ run.id }}" {% if baseline and baseline.run.id == run.id %}selected{% endif %}>#{{ run.id }} â€” {{ run.model }} ({{ run.timestamp }})</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Dataset (optional)</label>
      <input type="text" class="form-control" name="dataset" value="{{ dataset_value }}" placeholder="Defaults to baseline dataset">
    </div>
    <div class="col-12">
      <label class="form-label">Adjusted parameters</label>
      <textarea name="parameters" class="form-control" rows="4" placeholder="Override only what you need" spellcheck="false">{{ raw_params }}</textarea>
      <div class="form-text">Leave blank to reuse baseline parameters. Accepts JSON or key=value pairs.</div>
    </div>
    <div class="col-12 d-flex justify-content-end">
      <button type="submit" class="btn btn-primary">Run comparison</button>
    </div>
  </div>
</form>

<div class="row g-3">
  <div class="col-md-6">
    <h5>Baseline</h5>
    {% if baseline %}
      <p class="mb-1"><strong>Run:</strong> {{ baseline.run.id }} | <strong>Dataset:</strong> {{ baseline.run.dataset }}</p>
      <ul>
        {% for name, value in baseline.metrics.items() %}
          <li>{{ name }}: {{ value|round(4) }}</li>
        {% endfor %}
      </ul>
      <div class="d-flex flex-wrap gap-2">
        {% for art in baseline.artifacts %}
          <div class="text-center">
            <img src="/{{ art.path }}" class="img-fluid rounded border" style="max-height: 180px;" alt="{{ art.label }}">
            <div class="small text-muted">{{ art.label }}</div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">Choose a run to begin.</p>
    {% endif %}
  </div>
  <div class="col-md-6">
    <h5>New run</h5>
    {% if comparison %}
      <p class="mb-1"><strong>Run:</strong> {{ comparison.new.run.id }} | <strong>Dataset:</strong> {{ comparison.new.run.dataset }}</p>
      <ul>
        {% for name, value in comparison.new.metrics.items() %}
          <li>{{ name }}: {{ value|round(4) }}</li>
        {% endfor %}
      </ul>
      <div class="d-flex flex-wrap gap-2">
        {% for art in comparison.new.artifacts %}
          <div class="text-center">
            <img src="/{{ art.path }}" class="img-fluid rounded border" style="max-height: 180px;" alt="{{ art.label }}">
            <div class="small text-muted">{{ art.label }}</div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">Run a comparison to see updated results side-by-side.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
